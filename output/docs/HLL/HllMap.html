<!DOCTYPE html>
<!-- Start _layouts/doc_page.html-->
<html lang="en">

<head>
<!-- Start _include/site_head.html -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="datasketches">

<title>DataSketches | </title>

<link rel="shortcut icon" href="/img/favicon.png">

<!-- original source: https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css -->
<link rel="stylesheet" href="/css/font-awesome.min.css">
<!-- original source: https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css -->
<link rel="stylesheet" href="/css/bootstrap.min.css">

<link rel="stylesheet" href="/css/fonts.css" type="text/css">

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="stylesheet" href="/css/footer.css">
<link rel="stylesheet" href="/css/syntax.css">
<link rel="stylesheet" href="/css/docs.css">

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},showMathMenu:false,showMathMenuMSIE:false,showProcessingMessages:false});
</script>

<!-- original source: https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMX_HTML-full -->
<script src="/js/MathJax.js?config=TeX-AMS_HTML"></script>

<!-- original source: https://code.jquery.com/jquery.min.js -->
<script src="/js/jquery.min.js"></script>

<!-- original source: https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js -->
<script src="/js/bootstrap.min.js"></script> <!-- 3.2.0-->
<!-- End _include/site_head.html -->

</head>

<body>
<!-- Start _include/nav_bar.html -->
<div class="navbar navbar-inverse navbar-static-top ds-nav">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" style="padding-top: 0px; padding-bottom: 0px;">
        <span class="ds-small-h-logo"></span></a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/docs/Background/TheChallenge.html">
            <span class="fa fa-info-circle"></span> DOCUMENTATION</a>
        </li>
        <li>
          <!-- Start _include/javadocs.html -->
<ul class="nav navbar-nav navbar-right ds-nav">
  <li class="dropdown ds-nav" > <!--  <img class="java-logo" src="/img/JavaLogo.png" alt="java-logo"> -->
    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" style="padding: 0px 10px 0px 0px; line-height: 50px;"><span style="padding: 0px 10px 0px 0px;"> CODE DOCS<span class="caret"></span></span></a>
    <ul class="dropdown-menu ds-nav">
      <li><a href="https://apache.github.io/datasketches-java/6.2.0/">Java 8,11 Core</a></li>
      <li><a href="https://apache.github.io/datasketches-java/7.0.1/">Java 17 Core</a></li>
      <li><a href="https://apache.github.io/datasketches-cpp/5.2.0/">C++ Core</a></li>
      <li><a href="https://apache.github.io/datasketches-python/5.2.0/">Python</a></li>
      <li><a href="https://apache.github.io/datasketches-memory/3.0.2/">Java 8,11 Memory</a></li>
      <li><a href="https://apache.github.io/datasketches-memory/4.1.0/">Java 17 Memory</a></li>
      <li><a href="https://apache.github.io/datasketches-memory/6.0.0/">Java 21 Memory</a></li>
      <li><a href="/api/pig/snapshot/apidocs/index.html">Pig</a></li>
      <li><a href="/api/hive/snapshot/apidocs/index.html">Hive</a></li>
    </ul>
  </li>
</ul>
<!-- End _include/javadocs.html -->

        </li>
        <li>
          <span style="padding: 0px 10px 0px 0px;"></span>
        </li>
        <li>
          <a href="/docs/Community/Downloads.html">
            <span class="fa fa-download"></span> DOWNLOAD</a>
        </li>
        <!--
        <li>
          <a href="/docs/Architecture/Components.html">
            <span class="fa fa-github"></span> GITHUB</a>
        </li>
        -->
        <li>
          <a href="/docs/Community/Research.html">
            <span class="fa fa-paper-plane"></span> RESEARCH</a>
        </li>
        <li>
          <a href="/docs/Community/index.html" style="padding-top: 0; padding-bottom: 0;">
            <img class="ds-small-man" src="/img/datasketches-ManWhite.svg" alt="Man in community"><span style="line-height: 50px;">COMMUNITY</span></a>
        </li>
        <li>
          <ul class="nav navbar-nav navbar-right ds-nav">
            <li class="dropdown ds-nav" >
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" style="padding-top: 0; padding-bottom: 0;"><img class="apache-logo" src="/img/feather.svg" alt="Apache feather"><span style="line-height: 50px;">Apache</span><span class="caret"></span></a>
              <ul class="dropdown-menu ds-nav">
                <li><a href="https://www.apache.org/" target="_blank">Foundation</a></li>
                <li><a href="https://www.apache.org/events/current-event" target="_blank">Events</a></li>
                <li><a href="https://www.apache.org/licenses/" target="_blank">License</a></li>
                <li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank">Privacy Policy</a></li>
                <li><a href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></li>
                <li><a href="https://www.apache.org/security/" target="_blank">Security</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Sponsorship</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</div>
<!-- End _include/nav_bar.html -->


  <div class="container">
    <div class="row">
      <!-- Start ToC Block -->
      <div class="col-md-3">
        <div class="searchbox" style="position:relative">
          <gcse:searchbox-only></gcse:searchbox-only>
        </div>
<!-- Start _includes/toc.html -->
<!-- Computer Generated File, Do Not Edit! -->
<link rel="stylesheet" href="/css/toc.css">
<div id="toc" class="nav toc hidden-print">

  <p id="background">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_background">Background</a>
  </p>
  <div class="collapse" id="collapse_background">
    <li><a href="/docs/Background/TheChallenge.html">•The Challenge</a></li>
    <li><a href="/docs/Background/SketchOrigins.html">•Sketch Origins</a></li>
    <li><a href="/docs/Background/SketchElements.html">•Sketch Elements</a></li>
    <li><a href="/docs/Background/Presentations.html">•Presentations</a></li>
    <li><a href="https://github.com/apache/datasketches-website/tree/master/docs/pdf/DataSketches_deck.pdf">•Overview Slide Deck</a></li>
  </div>

  <p id="architecture-and-design">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_architecture_and_design">Architecture And Design</a>
  </p>
  <div class="collapse" id="collapse_architecture_and_design">
    <li><a href="/docs/Architecture/MajorSketchFamilies.html">•The Major Sketch Families</a></li>
    <li><a href="/docs/Architecture/LargeScale.html">•Large Scale Computing</a></li>
    <li><a href="/docs/Architecture/KeyFeatures.html">•Key Features</a></li>
    <li><a href="/docs/Architecture/SketchFeaturesMatrix.html">•Sketch Features Matrix</a></li>
    <li><a href="/docs/Architecture/Components.html">•Components</a></li>
    <li><a href="/docs/Architecture/SketchesByComponent.html">•Sketches by Component</a></li>
    <li><a href="/docs/Architecture/SketchCriteria.html">•Sketch Criteria</a></li>

    <p id="memory-component">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_memory_component">Memory Component</a>
    </p>
    <div class="collapse" id="collapse_memory_component">
      <li><a href="/docs/Memory/MemoryComponent.html">•Memory Component</a></li>
      <li><a href="/docs/Memory/MemoryPerformance.html">•Memory Component Performance</a></li>
    </div>
    <li><a href="/docs/Architecture/OrderSensitivity.html">•Notes on Order Sensitivity</a></li>
    <li><a href="/docs/Architecture/Concurrency.html">•Notes on Concurrency</a></li>
  </div>

  <p id="sketch-families">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_sketch_families">Sketch Families</a>
  </p>
  <div class="collapse" id="collapse_sketch_families">

    <p id="distinct-counting">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_distinct_counting">Distinct Counting</a>
    </p>
    <div class="collapse" id="collapse_distinct_counting">
      <li><a href="/docs/DistinctCountFeaturesMatrix.html">•Features Matrix</a></li>
      <li><a href="/docs/DistinctCountMeritComparisons.html">•Figures-of-Merit Comparison</a></li>
      <li><a href="/docs/CPC/CpcSketches.html">•CPC Sketches</a></li>
      <li><a href="/docs/HLL/HllSketches.html">•HyperLogLog Sketches</a></li>
      <li><a href="/docs/Theta/ThetaSketches.html">•Theta Sketches</a></li>
      <li><a href="/docs/Tuple/TupleSketches.html">•Tuple Sketches</a></li>
    </div>

    <p id="most-frequent">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_most_frequent">Most Frequent</a>
    </p>
    <div class="collapse" id="collapse_most_frequent">
      <li><a href="/docs/Frequency/FrequencySketches.html">•Frequency Sketches</a></li>
      <li><a href="/docs/Frequency/FrequencySketches.html#frequent-items-sketches">•Frequent Items Sketches</a></li>
      <li><a href="/docs/Frequency/FrequencySketches.html#frequent-distinct-tuples-sketches">•Frequent Distinct Tuples Sketches</a></li>
    </div>

    <p id="quantiles-and-histograms">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_and_histograms">Quantiles And Histograms</a>
    </p>
    <div class="collapse" id="collapse_quantiles_and_histograms">
      <li><a href="/docs/QuantilesAll/QuantilesOverview.html">•Quantiles Overview</a></li>
      <li><a href="/docs/KLL/KLLSketch.html">•KLL Sketches</a></li>
      <li><a href="/docs/Quantiles/ClassicQuantilesSketch.html">•Classic Quantiles Sketches</a></li>
      <li><a href="/docs/REQ/ReqSketch.html">•REQ Sketch</a></li>
      <li><a href="/docs/tdigest/tdigest.html">•t-digest</a></li>
    </div>

    <p id="sampling">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_sampling">Sampling</a>
    </p>
    <div class="collapse" id="collapse_sampling">
      <li><a href="/docs/Sampling/ReservoirSamplingSketches.html">•Reservoir Sampling Sketches</a></li>
      <li><a href="/docs/Sampling/VarOptSamplingSketches.html">•VarOpt Sampling Sketches</a></li>
    </div>
  </div>

  <p id="system-integrations">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_system_integrations">System Integrations</a>
  </p>
  <div class="collapse" id="collapse_system_integrations">
    <li><a href="/docs/SystemIntegrations/ApacheDruidIntegration.html">•Using Sketches in ApacheDruid</a></li>
    <li><a href="/docs/SystemIntegrations/ApacheHiveIntegration.html">•Using Sketches in Apache Hive</a></li>
    <li><a href="/docs/SystemIntegrations/ApachePigIntegration.html">•Using Sketches in Apache Pig</a></li>
    <li><a href="/docs/SystemIntegrations/ApachePinotIntegration.html">•Using Sketches in Apache Pinot</a></li>
    <li><a href="/docs/SystemIntegrations/PostgreSQLIntegration.html">•Using Sketches in PostgreSQL</a></li>
  </div>

  <p id="community">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_community">Community</a>
  </p>
  <div class="collapse" id="collapse_community">
    <li><a href="/docs/Community/index.html">•Community</a></li>
    <li><a href="/docs/Community/Downloads.html">•Downloads</a></li>
    <li><a href="/docs/Community/NewCommitterProcess.html">•Committer Process</a></li>
    <li><a href="/docs/Community/ReleaseProcessForCppComponents.html">•Release Process For CPP Components</a></li>
    <li><a href="/docs/Community/ReleaseProcessForJavaComponents.html">•Release Process For Java Components</a></li>
    <li><a href="/docs/Community/Transitioning.html">•Transitioning from prior GitHub Site</a></li>
  </div>

  <p id="research">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_research">Research</a>
  </p>
  <div class="collapse" id="collapse_research">
    <li><a href="/docs/Community/Research.html">•Research</a></li>
  </div>
</div>
<!-- End _includes/toc.html -->


<!-- Start _includes/tocScript.html -->
<script>
  (function () {

    var findLineItem = function (path) {
      return document.querySelector(`#toc [href="${path}"]`);
    };

    function findNavItem(path) {
      return document.querySelector(`.nav [href="${path}"]`);
    }

    var highlighLineItem = function (element) {
      element.classList.add('highlight');
    };

    var checkHasClass = function (element, className) {
      return element.className.split(' ').find(function (item) { return item === className || '' })
    }

    var findAllCollapseParents = function (element) {
      var collapseMenus = [];
      var elementPointer = element;
      while (elementPointer !== document.body) {
        if (checkHasClass(elementPointer, 'collapse')) {
          collapseMenus.push(elementPointer);
        }
        elementPointer = elementPointer.parentElement
      }
      return collapseMenus
    };

    var openMenuItem = function (element) {
      // $(element).collapse('show') would start a transition, adding `in` class instead.
      element.classList.add('in');
    };

    var openAllFromList = function (elementList) {
      elementList.forEach(openMenuItem);
    };

    var highlightAndOpenMenu = function () {
      // Highlight & expand nav item in the TOC
      var currentLineItem = findLineItem(document.location.pathname);
      highlighLineItem(currentLineItem);
      openAllFromList(findAllCollapseParents(currentLineItem));

      // Highlight nav item in top navigation
      highlighLineItem(findNavItem(document.location.pathname));
    };

    $(highlightAndOpenMenu);

  }());
</script>
<!-- End _includes/tocScript.html -->

      </div>
      <!-- End ToC Block -->
      <div class="col-md-9 doc-content">
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<h2 id="hyper-log-log-unique-count-map-sketch">Hyper Log Log Unique Count Map Sketch</h2>
<p>This is a real-time, key-value HLL mapping sketch that tracks approximate unique counts of
identifiers (the values) associated with each key. An example might be tracking the number of
unique user identifiers associated with each IP address. This map has been specifically designed
for the use-case where the number of keys is quite large (many millions) and the distribution of
identifiers per key is very skewed. A typical distribution where this works well is a
power-law distribution of identifiers per key of the form <i>y = Cx<sup>-α</sup></i>,
where <i>α</i> &lt; 0.5, and <i>C</i> is roughly <i>y<sub>max</sub></i>.
For example, with 100M keys, over 75% of the keys would have only
one identifier, 99% of the keys would have less than 20 identifiers, 99.9% would have less than
200 identifiers, and a very tiny fraction might have identifiers in the thousands.</p>

<p>This sketch is quite different from other sketches in the library:</p>

<ul>
  <li>The unique count estimate is returned with each update.  Most of the other sketches in the library require a separate getEstimate() method.  This sketch has a getEstimate(key) method, which is explained next.</li>
  <li>All keys that have been seen by the sketch are retained by the sketch.  Thus the number of keys retained (seen) by the sketch is not approximate.  The unique count of the identifiers associated with a particular key can be an approximation.  This means that at any time, the user can request the current estimate of the unique count of identifiers seen by a specifc key by calling the getEstimate(key) method.</li>
</ul>

<p>Because all keys that have been seen by the sketch are retained, this sketch can grow to be quite large.  The space consumed by this map is quite sensitive to the actual distribution of identifiers
per key, so you should characterize and or experiment with your typical input streams.
Nonetheless, our experiments on live streams of about 100M keys required space less than 1.4GB.</p>

<p>Given such highly-skewed distributions, using this map is far more efficient space-wise than
the alternative of dedicating the library HllSketch per key. Based on our use cases, after
subtracting the space required for key storage, the average bytes per key required for unique
count estimation (see method getAverageSketchMemoryPerKey()) is about 10 bytes.</p>

<p>Assuming that the frequency distribution of your identifiers per key is roughly power-law with a log-log slope of about -1, the total storage required for this sketch can be roughly computed as</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Size = (K + S) * T
    where K = Key size in bytes
          S = Average HLL Sketch Memory Per Key
          T = Total number of keys seen by the sketch
</code></pre></div></div>
<p>In our use-case we had a strong power-law distribution of IDs/key where the average HLL sketch memory per key was about 10.  With 100M keys, the space consumed was about 1.4 GB.  Nonetheless, the sketch tracks the memory usage for you and it can be obtained at any time with the getMemoryUsageBytes() method. The sketch also offers a getAverageSketchMemoryPerKey(), which estimates the value <em>S</em> in the above equation.</p>

<p>Internally, this map is implemented as a hierarchy of internal hash maps with progressively
increasing storage allocated for unique count estimation. As a key acquires more identifiers it
is “promoted” up to a higher internal map. The final map of keys is a map of compact HLL
sketches.</p>

<p>The unique values in all the internal maps, except the final HLL map, are stored in a special
form called a coupon. A coupon is a 16-bit value that fully describes a k=1024 HLL bin.
It contains 10 bits of address and a 6-bit HLL value.</p>

<p>All internal maps use a prime number size and Knuth’s Open Addressing Double Hash (OADH)
search algorithm.</p>

<p>The internal base map holds all the keys and each key is associated with one 16-bit value.
Initially, the value is a single coupon. Once the key is promoted, this 16-bit field contains a
reference to the internal map where the key is still active.</p>

<p>The intermediate maps between the base map and the final HLL map are of two types.
The first few of these are called traverse maps where the coupons are
stored as unsorted arrays. After the traverse maps are the coupon hash maps, where the coupons
are stored in small OASH (Open Address Single Hash) hash tables.</p>

<p>All the intermediate maps support deletes and can dynamically grow and shrink as required by
the input stream.</p>

<p>The sketch estimator algorithms are unbiased with a Relative Standard Error (RSE)
of about 2.6% with 68% confidence, or equivalently, about 5.2% with a 95% confidence.</p>

<p>At the time this sketch was designed there was no requirement for merging these sketches, 
so the merge operation was never implemented.  This sketch was designed to operate on
a single server for real-time tracking and monitoring.</p>

<h3 id="accuracy">Accuracy</h3>

<p>The accuracy behavior of the UniqueCountMap sketch will be similar to the following graph:</p>

<p><img class="doc-img-half" src="/docs/img/hll/RSE_UniqueCountMap.png" alt="RSE_UniqueCountMap.png" /></p>

<p>The blue curve is the RSE for the sketch and has two regions corresponding to two different estimator algorithms.
The first estimator is for the low count region less than 192 uniques, and the second estimator is used for counts
greater than 192.</p>

<p>The theoretical bound for the first estimator is shown as the red dashed line. The theoretical bound for the high
range estimator is shown as the green dashed line.</p>

<h3 id="speed">Speed</h3>

<p>The update/estimate speed behavior of the this sketch is dependent on the actual distribution of identifiers per key, 
so it is difficult to characterize.  However, in our own testing with real data, we observed update/estimate speeds of less than 500 nanoseconds.</p>


      </div> <!-- End content -->
    </div> <!-- End row -->
  </div> <!-- End Container -->

<!-- Start _include/page_footer.html -->
<footer class="ds-footer">
  <div class="container">
    <div class="text-center">
      <p>
        <div>Copyright © 2025 <a href="https://www.apache.org">Apache Software Foundation</a>, 
          Licensed under the Apache License, Version 2.0. All Rights Reserved.
          | <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a><br>
          Apache DataSketches, Apache, the Apache feather logo, and the Apache DataSketches project logos are trademarks of The Apache Software Foundation.<br>
          All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </div>

    </div>
  </div>
</footer>
<!-- End _include/page_footer.html -->

</body>

</html>
<!-- End _layouts/doc_page.html-->