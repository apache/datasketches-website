<!DOCTYPE html>
<!-- Start _layouts/doc_page.html-->
<html lang="en">

<head>
  <!-- Start site_head.html include-->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="datasketches">

<title>DataSketches | </title>

<link rel="shortcut icon" href="/img/favicon.png">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700,300italic|Open+Sans:300italic,400italic,600italic,400,300,600'
  rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="stylesheet" href="/css/footer.css">
<link rel="stylesheet" href="/css/syntax.css">
<link rel="stylesheet" href="/css/docs.css">



<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full">
</script>
<script src="https://code.jquery.com/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<!-- End site_head.html include-->

</head>

<body>
  <!-- Start page_header.html include -->
<div class="navbar navbar-inverse navbar-static-top ds-nav">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <!-- navbar-brand: https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css -->
      <!-- /css/main.css:57:.logo -->
      <a class="navbar-brand logo" href="/">DataSketches</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/overview.html">
            <span class="fa fa-info-circle"></span> OVERVIEW</a>
        </li>
        <li>
          <a href="/docs/Community/Downloads.html">
            <span class="fa fa-download"></span> DOWNLOAD</a>
        </li>
        <li>
          <a href="https://github.com/apache?utf8=%E2%9C%93&q=datasketches&type=&language=">
            <span class="fa fa-github"></span> GITHUB</a>
        </li>
        <li>
          <a href="/docs/Community/Research.html">
            <span class="fa fa-paper-plane"></span> RESEARCH</a>
        </li>
        <li>
          <a href="https://lists.apache.org/list.html?users@datasketches.apache.org">
            <span class="fa fa-comment"></span> FORUM</a>
        </li>
        <ul class="nav navbar-nav navbar-right ds-nav">
          <li class="dropdown ds-nav">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><img class="apache-logo" src="https://www.apache.org/foundation/press/kit/feather.svg"/>Apache <span class="caret"></span></a>
            <ul class="dropdown-menu ds-nav">
              <li><a href="https://www.apache.org/" target="_blank">Foundation</a></li>
              <li><a href="https://www.apache.org/events/current-event" target="_blank">Events</a></li>
              <li><a href="https://www.apache.org/licenses/" target="_blank">License</a></li>
              <li><a href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></li>
              <li><a href="https://www.apache.org/security/" target="_blank">Security</a></li>
              <li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Sponsorship</a></li>
            </ul>
          </li>

      </ul>
    </div>
  </div>
</div>
<!-- End page_header.html include -->


  <div class="ds-header">
    <div class="container">
      <h4>API Snapshots:
        <a href="/api/java/snapshot/apidocs/index.html">Java Core</a>,
        <a href="/api/memory/snapshot/apidocs/index.html">Memory</a>,
        <a href="/api/pig/snapshot/apidocs/index.html">Pig</a>,
        <a href="/api/hive/snapshot/apidocs/index.html">Hive</a>,
      </h4>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <div class="searchbox" style="position:relative">
          <gcse:searchbox-only></gcse:searchbox-only>
        </div>
        <!-- Computer Generated File, Do Not Edit! -->
<link rel="stylesheet" href="/css/toc.css">
<div id="toc" class="nav toc hidden-print">

  <p id="overview">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_overview">Overview</a>
  </p>
  <div class="collapse" id="collapse_overview">
    <li><a href="/docs/TheChallenge.html">The Challenge</a></li>
    <li><a href="/docs/MajorSketchFamilies.html">The Major Sketch Families</a></li>
    <li><a href="/docs/SketchOrigins.html">Sketch Origins</a></li>
    <li><a href="/docs/SketchElements.html">Sketch Elements</a></li>
    <li><a href="/docs/LargeScale.html">Large Scale Computing</a></li>

    <p id="architecture">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_architecture">Architecture</a>
    </p>
    <div class="collapse" id="collapse_architecture">
      <li><a href="/docs/Architecture/KeyFeatures.html">Key Features</a></li>
      <li><a href="/docs/Architecture/Components.html">Components</a></li>
      <li><a href="/docs/Architecture/SketchesByComponent.html">Sketches by Component</a></li>
      <li><a href="/docs/Architecture/SketchesCriteria.html">Sketch Criteria</a></li>
      <li><a href="/docs/Architecture/OrderSensitivity.html">Notes on Order Sensitivity</a></li>
      <li><a href="/docs/Architecture/Concurrency.html">Notes on Concurrency</a></li>
    </div>
    <li><a href="https://github.com/apache/incubator-datasketches-website/tree/master/docs/pdf/DataSketches_deck.pdf">Overview Slide Deck</a></li>
  </div>

  <p id="community">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_community">Community</a>
  </p>
  <div class="collapse" id="collapse_community">
    <li><a href="/docs/Community/index.html">Community</a></li>
  </div>

  <p id="research">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_research">Research</a>
  </p>
  <div class="collapse" id="collapse_research">
    <li><a href="/docs/Community/Research.html">Research</a></li>
  </div>

  <p id="distinct-counting">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_distinct_counting">Distinct Counting</a>
  </p>
  <div class="collapse" id="collapse_distinct_counting">
    <li><a href="/docs/DistinctCountCapabilitiesMatrix.html">Capabilities Matrix</a></li>

    <p id="hyperloglog-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_hyperloglog_sketches">HyperLogLog Sketches</a>
    </p>
    <div class="collapse" id="collapse_hyperloglog_sketches">
      <li><a href="/docs/HLL/HLL.html">HLL Sketch</a></li>
      <li><a href="/docs/HLL/HllMap.html">HLL Map Sketch</a></li>

      <p id="hll-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_hll_examples">HLL Examples</a>
      </p>
      <div class="collapse" id="collapse_hll_examples">
        <li><a href="/docs/HLL/HllJavaExample.html">HLL Sketch Java Example</a></li>
        <li><a href="/docs/HLL/HllPigUDFs.html">HLL Sketch Pig UDFs</a></li>
        <li><a href="/docs/HLL/HllHiveUDFs.html">HLL Sketch Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>

      <p id="hll-studies">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_hll_studies">HLL Studies</a>
      </p>
      <div class="collapse" id="collapse_hll_studies">
        <li><a href="/docs/HLL/Hll_vs_G_Hllpp.html">HLL vs Google HLL++</a></li>
        <li><a href="/docs/HLL/Hll_vs_CS_Hllpp.html">HLL vs Clearspring HLL++</a></li>
        <li><a href="/docs/HLL/HllSketchVsDruidHyperLogLogCollector.html">HLL Sketch vs Druid HyperLogLogCollector</a></li>
      </div>
    </div>

    <p id="theta-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_sketches">Theta Sketches</a>
    </p>
    <div class="collapse" id="collapse_theta_sketches">
      <li><a href="/docs/Theta/ThetaSketchFramework.html">Theta Sketch Framework</a></li>

      <p id="theta-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_examples">Theta Examples</a>
      </p>
      <div class="collapse" id="collapse_theta_examples">
        <li><a href="/docs/Theta/ConcurrentThetaSketch.html">Concurrent Theta Sketch</a></li>
        <li><a href="/docs/Theta/ThetaJavaExample.html">Theta Sketch Java Example</a></li>
        <li><a href="/docs/Theta/ThetaSparkExample.html">Theta Sketch Spark Example</a></li>
        <li><a href="/docs/Theta/ThetaPigUDFs.html">Theta Sketch Pig UDFs</a></li>
        <li><a href="/docs/Theta/ThetaHiveUDFs.html">Theta Sketch Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>

      <p id="kmv-tutorial">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_kmv_tutorial">KMV Tutorial</a>
      </p>
      <div class="collapse" id="collapse_kmv_tutorial">
        <li><a href="/docs/Theta/InverseEstimate.html">The Inverse Estimate</a></li>
        <li><a href="/docs/Theta/KMVempty.html">Empty Sketch</a></li>
        <li><a href="/docs/Theta/KMVfirstEst.html">First Estimator</a></li>
        <li><a href="/docs/Theta/KMVbetterEst.html">Better Estimator</a></li>
        <li><a href="/docs/Theta/KMVrejection.html">Rejection Rules</a></li>
        <li><a href="/docs/Theta/KMVupdateVkth.html">Update V(kth) Rule</a></li>
      </div>

      <p id="set-operations-and-p-sampling">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_set_operations_and_p-sampling">Set Operations and P-sampling</a>
      </p>
      <div class="collapse" id="collapse_set_operations_and_p-sampling">
        <li><a href="/docs/Theta/ThetaSketchSetOps.html">Set Operations</a></li>
        <li><a href="/docs/Theta/ThetaPSampling.html"><i>p</i>-Sampling</a></li>
      </div>

      <p id="accuracy">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_accuracy">Accuracy</a>
      </p>
      <div class="collapse" id="collapse_accuracy">
        <li><a href="/docs/Theta/ThetaAccuracy.html">Basic Accuracy</a></li>
        <li><a href="/docs/Theta/ThetaAccuracyPlots.html">Accuracy Plots</a></li>
        <li><a href="/docs/Theta/ThetaErrorTable.html">Relative Error Table</a></li>
        <li><a href="/docs/Theta/ThetaSketchSetOpsAccuracy.html">SetOp Accuracy</a></li>
        <li><a href="/docs/Theta/AccuracyOfDifferentKUnions.html">Unions With Different k</a></li>
      </div>

      <p id="size">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_size">Size</a>
      </p>
      <div class="collapse" id="collapse_size">
        <li><a href="/docs/Theta/ThetaSize.html">Theta Sketch Size</a></li>
      </div>

      <p id="speed">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_speed">Speed</a>
      </p>
      <div class="collapse" id="collapse_speed">
        <li><a href="/docs/Theta/ThetaUpdateSpeed.html">Update Speed</a></li>
        <li><a href="/docs/Theta/ThetaMergeSpeed.html">Merge Speed</a></li>
      </div>

      <p id="theta-sketch-theory">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_sketch_theory">Theta Sketch Theory</a>
      </p>
      <div class="collapse" id="collapse_theta_sketch_theory">
        <li><a href="https://github.com/apache/incubator-datasketches-website/tree/master/docs/pdf/ThetaSketchFramework.pdf">Theta Sketch Framework (PDF)</a></li>
        <li><a href="https://github.com/apache/incubator-datasketches-website/tree/master/docs/pdf/SketchEquations.pdf">Sketch Equations (PDF)</a></li>
        <li><a href="https://github.com/apache/incubator-datasketches-website/tree/master/docs/pdf/DataSketches.pdf">DataSketches (PDF)</a></li>
        <li><a href="/docs/Theta/ThetaConfidenceIntervals.html">Confidence Intervals Notes</a></li>
        <li><a href="/docs/Theta/ThetaMergingAlgorithm.html">Merging Algorithm Notes</a></li>
        <li><a href="/docs/Theta/ThetaReferences.html">Theta References</a></li>
      </div>
    </div>

    <p id="tuple-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_tuple_sketches">Tuple Sketches</a>
    </p>
    <div class="collapse" id="collapse_tuple_sketches">
      <li><a href="/docs/Tuple/TupleOverview.html">Tuple Overview</a></li>

      <p id="tuple-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_tuple_examples">Tuple Examples</a>
      </p>
      <div class="collapse" id="collapse_tuple_examples">
        <li><a href="/docs/Tuple/TupleJavaExample.html">Tuple Java Example</a></li>
        <li><a href="/docs/Tuple/TupleEngagementExample.html">Tuple Engagement Example</a></li>
        <li><a href="/docs/Frequency/FrequentDistinctTuplesSketch.html">Frequent Distinct Tuples Sketch</a></li>
        <li><a href="/docs/Tuple/TuplePigUDFs.html">Tuple Pig UDFs</a></li>
        <li><a href="/docs/Tuple/TupleHiveUDFs.html">Tuple Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>
    </div>
  </div>

  <p id="most-frequent">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_most_frequent">Most Frequent</a>
  </p>
  <div class="collapse" id="collapse_most_frequent">
    <li><a href="/docs/Frequency/FrequencySketchesOverview.html">Frequency Sketches Overview</a></li>

    <p id="frequent-item-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_frequent_item_sketches">Frequent Item Sketches</a>
    </p>
    <div class="collapse" id="collapse_frequent_item_sketches">
      <li><a href="/docs/Frequency/FrequentItemsOverview.html">Frequent Items Overview</a></li>
      <li><a href="/docs/Frequency/FrequentItemsErrorTable.html">Frequent Items Error Table</a></li>
      <li><a href="/docs/Frequency/FrequentItemsReferences.html">Frequent Items References</a></li>

      <p id="most-frequent-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_most_frequent_examples">Most Frequent Examples</a>
      </p>
      <div class="collapse" id="collapse_most_frequent_examples">
        <li><a href="/docs/Frequency/FrequentItemsJavaExample.html">Frequent Items Java Example</a></li>
        <li><a href="/docs/Frequency/FrequentItemsPigUDFs.html">Frequent Items Pig UDFs</a></li>
        <li><a href="/docs/Frequency/FrequentItemsHiveUDFs.html">Frequent Items Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>
    </div>

    <p id="frequent-distinct-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_frequent_distinct_sketches">Frequent Distinct Sketches</a>
    </p>
    <div class="collapse" id="collapse_frequent_distinct_sketches">
      <li><a href="/docs/Frequency/FrequentDistinctTuplesSketch.html">Frequent Distinct Tuples Sketch</a></li>
    </div>
  </div>

  <p id="quantiles-and-histograms">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_and_histograms">Quantiles And Histograms</a>
  </p>
  <div class="collapse" id="collapse_quantiles_and_histograms">
    <li><a href="/docs/Quantiles/QuantilesOverview.html">Quantiles Overview</a></li>
    <li><a href="/docs/Quantiles/QuantilesAccuracy.html">Quantiles Accuracy and Size</a></li>

    <p id="quantiles-examples">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_examples">Quantiles Examples</a>
    </p>
    <div class="collapse" id="collapse_quantiles_examples">
      <li><a href="/docs/Quantiles/QuantilesJavaExample.html">Quantiles Sketch Java Example</a></li>
      <li><a href="/docs/Quantiles/QuantilesPigUDFs.html">Quantiles Sketch Pig UDFs</a></li>
      <li><a href="/docs/Quantiles/QuantilesHiveUDFs.html">Quantiles Sketch Hive UDFs</a></li>
      <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
    </div>

    <p id="quantiles-studies">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_studies">Quantiles Studies</a>
    </p>
    <div class="collapse" id="collapse_quantiles_studies">
      <li><a href="/docs/Quantiles/KLLSketch.html">New KLL sketch and comparison with DoublesSketch</a></li>
      <li><a href="/docs/Quantiles/KllSketchVsTDigest.html">KLL sketch vs t-digest</a></li>
      <li><a href="/docs/Quantiles/DruidApproxHistogramStudy.html">Druid Approximate Histogram</a></li>
      <li><a href="/docs/Quantiles/MomentsSketchStudy.html">Moments Sketch Study</a></li>
      <li><a href="/docs/Quantiles/QuantilesStreamAStudy.html">Quantiles StreamA Study</a></li>
    </div>

    <p id="quantiles-sketch-theory">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_sketch_theory">Quantiles Sketch Theory</a>
    </p>
    <div class="collapse" id="collapse_quantiles_sketch_theory">
      <li><a href="https://github.com/apache/incubator-datasketches-website/tree/master/docs/pdf/Quantiles_KLL.pdf">Optimal Quantile Approximation in Streams</a></li>
      <li><a href="/docs/Quantiles/QuantilesReferences.html">Quantiles References</a></li>
    </div>
  </div>

  <p id="sampling">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_sampling">Sampling</a>
  </p>
  <div class="collapse" id="collapse_sampling">
    <li><a href="/docs/Sampling/ReservoirSampling.html">Reservoir Sampling</a></li>
    <li><a href="/docs/Sampling/ReservoirSamplingPerformance.html">Reservoir Sampling Performance</a></li>
    <li><a href="/docs/Sampling/VarOptSampling.html">VarOpt Sampling</a></li>

    <p id="sampling-examples">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_sampling_examples">Sampling Examples</a>
    </p>
    <div class="collapse" id="collapse_sampling_examples">
      <li><a href="/docs/Sampling/ReservoirSamplingJava.html">Reservoir Sampling Java Example</a></li>
      <li><a href="/docs/Sampling/ReservoirSamplingPigUDFs.html">Reservoir Sampling Pig UDFs</a></li>
      <li><a href="/docs/Sampling/VarOptSamplingJava.html">VarOpt Sampling Java Example</a></li>
      <li><a href="/docs/Sampling/VarOptPigUDFs.html">VarOpt Sampling Pig UDFs</a></li>
    </div>
  </div>

  <p id="memory-package">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_memory_package">Memory Package</a>
  </p>
  <div class="collapse" id="collapse_memory_package">
    <li><a href="/docs/Memory/MemoryPackage.html">Memory Package</a></li>
    <li><a href="/docs/Memory/MemoryPerformance.html">Memory Package Performance</a></li>
  </div>

  <p id="command-line">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_command_line">Command Line</a>
  </p>
  <div class="collapse" id="collapse_command_line">
    <li><a href="/docs/CommandLine/CommandLine.html">Creating Command Line Executables</a></li>
  </div>

  <p id="who-uses">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_who_uses">Who Uses</a>
  </p>
  <div class="collapse" id="collapse_who_uses">
    <li><a href="/docs/WhoUses.html">Who Uses</a></li>
  </div>
</div>
<script>
  (function () {

    var findLineItem = function (path) {
      return document.querySelector(`[href="${path}"]`);
    };

    var highlighLineItem = function (element) {
      element.classList.add('highlight');
    };

    var checkHasClass = function (element, className) {
      return element.className.split(' ').find(function (item) { return item === className || '' })
    }

    var findAllCollapseParents = function (element) {
      var collapseMenus = [];
      var elementPointer = element;
      while (elementPointer !== document.body) {
        if (checkHasClass(elementPointer, 'collapse')) {
          collapseMenus.push(elementPointer);
        }
        elementPointer = elementPointer.parentElement
      }
      return collapseMenus
    };

    var findMatchingCollapseMenu = function (collapseItem) {
      return document.querySelector(`[href="#${collapseItem.id}"]`);
    };

    var findAllParentMenus = function (element) {
      var parentMenus = []
      var elementPointer = element;
      while (elementPointer !== document.body) {
        if (elementPointer.className.split(' ').indexOf('menu') > -1) {
          parentMenus.push(elementPointer);
        }
        elementPointer = elementPointer.parentElement;
      }
      return parentMenus;
    }

    var openMenuItem = function (element) {
      element.click();
    };

    var openAllFromList = function (elementList) {
      elementList.forEach(function (element) {
        console.log(element)
        openMenuItem(findMatchingCollapseMenu(element))
      });
    };

    var highlightAndOpenMenu = function () {
      var currentLineItem = findLineItem(document.location.pathname);
      highlighLineItem(currentLineItem)
      openAllFromList(findAllCollapseParents(currentLineItem));
    };

    $(highlightAndOpenMenu);

  }());
</script>


      </div>
      <div class="col-md-9 doc-content">
        <a class="btn btn-default btn-xs visible-xs-inline-block visible-sm-inline-block" href="/_includes/toc.html">Table of Contents</a>
        <!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<h2 id="frequent-distinct-tuples-sketch">Frequent Distinct Tuples Sketch</h2>

<h3 id="the-task">The Task</h3>
<p>Suppose our data is a stream of pairs {IP address, User ID} and we want to identify the IP addresses that
have the most distinct User IDs.  Or conversely, we would like to identify the User IDs that have the 
most distinct IP addresses.
This is a common challenge in the analysis of big data and the FDT sketch helps solve this problem using
probabilistic techniques.</p>

<p>More generally, given a multiset of tuples with <i>N</i> dimensions <i>{d1,d2, d3, …, dN}</i>, 
and a primary subset of dimensions <i>M &lt; N</i>, our task is to identify the combinations of 
<i>M</i> subset dimensions that have the <i>most frequent</i> number of distinct combinations 
of the <i>N - M</i> non-primary dimensions.</p>

<h3 id="definitions">Definitions</h3>

<ul>
  <li><strong>Equal Distribution Threshold</strong></li>
</ul>

<p>Suppose we have a stream of 160 items where the stream consists of four item types: A, B, C, and D.
If the distribution of occurances was shared equally across the four items each would
occur exactly 40 times or 25% of the total distribution of 160 items. Thus the equally distributed
(or fair share) <i>threshold</i> would be 25% or as a fraction 0.25.</p>

<ul>
  <li><strong>Most Frequent</strong></li>
</ul>

<p>We define <i>Most Frequent</i> items as those that consume more than the fair share threshold of the
total occurances (also called the <i>weight</i>) of the entire stream.</p>

<p>Suppose we have a stream of 160 items where the stream consists of four item types: A, B, C, and D,
which have the following frequency distribution:</p>

<ul>
  <li>A occurs 70 times</li>
  <li>B occurs 50 times</li>
  <li>C occurs 30 times</li>
  <li>D occurs 10 times</li>
</ul>

<p>We would declare that A is the most frequent and B is the next most frequent. We would not
declare C and D in a list of most frequent items since their respective frequencies are below 
the threshold of 40 or 25%.</p>

<p>If all items occured with a frequency of 40, we could not declare 
any item as most frequent. Requesting a list of the “Top 4” items could be a list of the 4 items in any random
order, or a list of zero items, depending on policy.</p>

<ul>
  <li><strong>Relative Standard Error or RSE</strong></li>
</ul>

<p>When a stream becomes too large with too many different item types to efficiently process exacty we must turn 
to statistical methods to estimate the most frequent items. The returned list of “most frequent items” will
have an associated “estimated frequency” that has an error component that is a random variable. 
The RSE is a measure of the width of the error distribution of this component and computed similarly to how a 
Standard Deviation is computed. It is relative to the estimated frequency in that the standard
width of the error distribution can be computed as <i>estimate * (1 + RSE)</i> and <i>estimate * (1 - RSE)</i>.</p>

<ul>
  <li><strong>Primary Key</strong></li>
</ul>

<p>We define a specific combination of the <i>M</i> primary dimensions as a <i>Primary Key</i>
and all combinations of the <i>M</i> primary dimensions as the set of <i>Primary Keys</i>.</p>

<ul>
  <li><strong>Group</strong></li>
</ul>

<p>We define the set of all combinations of <i>N-M</i> non-primary dimensions associated with a
single primary key as a <i>Group</i>.</p>

<p>For example, assume <i>N = 3, M = 2</i>, where the set of Primary Keys are defined by
<i>{d1, d2}</i>. After populating the sketch with a stream of tuples all of size <i>N = 3</i>,
we wish to identify the Primary Keys that have the most frequent number of distinct occurrences
of <i>{d3}</i>. Equivalently, we want to identify the Primary Keys with the largest Groups.</p>

<p>Alternatively, if we choose the Primary Key as <i>{d1}</i>, then we can identify the
<i>{d1}</i>s that have the largest groups of <i>{d2, d3}</i>. The choice of
which dimensions to choose for the Primary Keys is performed in a post-processing phase
after the sketch has been populated. Thus, multiple queries can be performed against the
populated sketch with different selections of Primary Keys.</p>

<p>An important caveat is that if the distribution is too flat, there may not be any
“most frequent” combinations of the primary keys above the threshold. 
Also, if one primary key is too dominant, the sketch may be able to only report on the single 
most frequent primary key combination, which means the possible existance of false negatives.</p>

<p>In this implementation the input tuples presented to the sketch are string arrays.</p>

<h3 id="using-the-fdtsketch">Using the FdtSketch</h3>

<p>Let’s leverate the challenge at the beginning to crete a concrete example. 
Let’s assume <i>N = 2</i> and let <i>d1 := IP address</i>, and <i>d2 := User ID</i>.</p>

<p>If we choose <i>{d1}</i> as the Primary Keys, then the sketch will allow us to identify the
<i>IP addresses</i> that have the largest populations of distinct <i>User IDs</i>.</p>

<p>Conversely, if we choose <i>{d2}</i> as the Primary Keys, the sketch will allow us to identify the
<i>User IDs</i> with the largest populations of distinct <i>IP addresses</i>.</p>

<p>Let’s set the threshold to 0.01 (1%) and the RSE to 0.05 (5%). This is telling the sketch to size itself 
such that items with distinct frequency counts greater than 1% of the total distinct population will be 
detectable and have a distinct frequency estimation error of less than or equal to 5% with 86% confidence.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Construct the sketch
FdtSketch sketch = new FdtSketch(0.01, 0.05);
</code></pre></div></div>

<p>Assume the incoming data is a stream of {IP address, User ID} pairs:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//Populate
while (inputStream.hasRemainingItems()) {
  String[] in = new String[] {Pair.IPaddress, Pair.userID};
  sketch(in);
}
</code></pre></div></div>

<p>We are done populating the sketch, now we post process the data in the sketch:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int[] priKeyIndices = new int[] {0}; //identifies the IP address as the primary key
int numStdDev = 2; //for 95% confidence intervals
int limit = 20; //list only the top 20 groups
char sep = '|'; //the separator charactor for the group dimensions as strings
List&lt;Group&gt; list = sketch.getResult(priKeyIndices, limit, numStdDev, sep);
System.out.println(Group.getHeader())
Iterator&lt;Group&gt; itr = list.iterator()
while (itr.hasNext()) {
  System.out.println(itr.next())
}
</code></pre></div></div>

<p>If we want the converse relation we assign the UserID as the primary key. Note that we do not have to repopulate the sketch!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int[] priKeyIndices = new int[] {1}; //identifies the User ID as the primary key
...
</code></pre></div></div>

<h3 id="understanding-the-group-output-columns">Understanding the Group output columns</h3>

<p>When the Group is printed as a string, it will output seven columns as follows:</p>

<ul>
  <li>
    <p><strong>Count</strong>: This is the number of retained occurrences in the sketch that belong to this group.</p>
  </li>
  <li>
    <p><strong>Est</strong> This is the sketch’s estimate of the distinct cardinality of this group based on the Count and the sketche’s internal state of Theta.</p>
  </li>
  <li>
    <p><strong>UB</strong>: The Upper Bound of the confidence interval based on the given numStdDev.</p>
  </li>
  <li>
    <p><strong>LB</strong>: The Lower Bound of the confidence interval based on the given numStdDev.</p>
  </li>
  <li>
    <p><strong>Fraction</strong>: The fractional proportion of the cardinality of the entire sketch that this group represents.</p>
  </li>
  <li>
    <p><strong>RSE</strong>: The estimated RSE of this group based on the properties of this group and the internal properties of this sketch.</p>
  </li>
  <li>
    <p><strong>PriKey</strong>: The string identifying this group.</p>
  </li>
</ul>

<h3 id="error-behavior">Error Behavior</h3>

<p>Note: the code for the following study can be found in the characterization repository 
<a href="https://github.com/DataSketches/characterization/tree/master/src/main/java/org/apache/datasketches/characterization/fdt">here</a> and the configuration file can be found <a href="https://github.com/DataSketches/characterization/tree/master/src/main/resources/fdt">here</a>.</p>

<p>In order to study the error behavior of this sketch a power-law distribution with a slope of -1 was created. The head of the distribution was a single item with a cardinality of 16384, and the tail of the distribution was 16384 items each with a cardinality of one. All the points inbetween were items that have multiplicities and cardinalities that would fall on a straight line plotted on a Log-X, Log-Y graph. This generated an input stream of about 850K (Key, value) pairs, which was input into the sketch and is considered one trial.  The sketch was constructed with a target
threshold of 1% and a target RSE of 5%.</p>

<p>Twenty such trials were run and the error distribution quantiles of the results were computed and is shown in the following graph.</p>

<p><img class="doc-img-half" src="/docs/img/fdt/FdtGroupErrorQuantiles.png" alt="FdtGroupErrorQuantiles.png" /></p>

<p>The X-axis is the true cardinality. Of the nearly 24K groups captured by the sketch of the 
input stream of over 100K groups this graph is a view of the top 500, which is more than enough to demonstrate the error behavior.</p>

<p>The Y-axis is the relative error.</p>

<p>The blue dots represent the error of a single group from the top 500 groups. Not all of the top 500 groups are shown on the graph as number of them had true cardinalities of less than 256. Also many of the dots represent multiple groups since groups with the same Count and the same true cardinality will result in the same exact computed error, thus plotted at the same exact point.</p>

<p>The red line is the contour of the quantile(0.84) points of the error distribution at each point along the X-axis. This quantile contour would be equivalent to the +1 standard deviation from the mean of a Gaussian distribution. But since these are quantile measurements of the actual error distribution there is no assuption whatsoever that the error distribution is Gaussian.  It is just a convenient reference contour. Similarly the black line is the contour of the quantile(0.159), which corresponds to the -1 standard deviation from the mean. Between these two contours would represent 68% of the distribution (or 68% confidence), which is equivalent to saying within +/- 1 standard deviation of the mean (if it were Gaussian).  The green line is the contour of the medians (quantile(0.5)).</p>

<p>The following table is the list of the top 10 results from just one of the trials. The Group class was extended to include more columns at the end which were useful for this study. (This was easy to do and does not require any special access.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Count         Est          UB          LB      Thresh         RSE      PriKey   xG      yU         Err
 1338    16511.86    16957.05    16078.18    0.019521    0.026962   1,1,16384    1   16384    0.007804
  666     8218.91     8536.72     7912.67    0.009717    0.038668    2,1,8192    2    8192    0.003285
  660     8144.87     8461.30     7840.01    0.009629    0.038850    2,2,8192    2    8192   -0.005754
  475     5861.83     6132.21     5603.08    0.006930    0.046124    3,1,5461    3    5461    0.073400
  450     5553.32     5816.82     5301.44    0.006565    0.047449    3,2,5461    3    5461    0.016905
  400     4936.28     5185.44     4698.76    0.005836    0.050475    3,3,5461    3    5461   -0.096085
  355     4380.95     4616.42     4157.14    0.005179    0.053748    4,2,4096    4    4096    0.069568
  344     4245.20     4477.19     4024.87    0.005019    0.054648    4,1,4096    4    4096    0.036426
  321     3961.37     4185.90     3748.50    0.004683    0.056681    4,3,4096    4    4096   -0.032870
  306     3776.26     3995.79     3568.40    0.004464    0.058134    5,5,3277    5    3277    0.152351
</code></pre></div></div>

<p>The blue dot on the very left represents the single item with the largest cardinality. As you can see from the table, it’s estimation error is quite small (about 0.78%). At this point the +/- 1 S.D. contours are at about +3.4% and -2.5% and the median is about 0.78%</p>

<p>As you follow the graph to the right you are observing the error distribution as the cardinalities get smaller.  Smaller groups have fewer samples from the sketch thus their estimation error will, of course, grow larger.  What this graph demonstrates is the the error properties are well behaved and what one would expect from this sketch.</p>


      </div>
    </div>
  </div>

  <!-- Start page_footer.html include -->
<footer class="ds-footer">
  <div class="container">
    <div class="text-center">
      <p>
        <div>Copyright © 2019 <a href="https://www.apache.org">Apache Software Foundation</a>, 
          Licensed under the Apache License, Version 2.0. All Rights Reserved.<br/>
          Apache DataSketches, Apache, the Apache feather logo, and the Apache DataSketches project logos are trademarks of The Apache Software Foundation.<br/>
          All other marks mentioned may be trademarks or registered trademarks of their respective owners.<br/>
          <br/>
          <b>Disclaimer:</b> Apache DataSketches is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
        </div>
        
      </p>
    </div>
  </div>
</footer>
<!-- End page_footer.html include -->

</body>

</html>
<!-- End _layouts/doc_page.html-->
